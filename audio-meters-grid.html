<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSG – Källor (vänster) + Visning (höger) · Generator hörs, System tyst tills monitor ON</title>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#0f1624; --ink:#e8eef9; --muted:#98a6c7; --acc:#6aa6ff; --grid:#1d2a46;
      --ok:#7ee787; --warn:#ffb86b; --err:#ff6b6b;
      --btn:#2d6bff;           /* normal blå */
      --btn-dark:#1e4edd;      /* mörkare blå (aktiv/unmuted) */
      --btn-ghost:#0b1222;     /* ghost/muted bakgrund */
      --outline:#1a2641;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overflow:hidden}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,15,26,.95),rgba(11,15,26,.6));backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #17223a}
    h1{margin:0;padding:16px 20px;font-size:16px;letter-spacing:.3px}

    /* Grid: vänster = 2 käll-rutor + extra halv-hög huvudruta under; höger = visning som spänner 2 översta raderna */
    .wrap{padding:16px 20px;display:grid;gap:16px;grid-template-columns: 360px 1fr;grid-template-rows: 1fr 1fr auto; height:calc(100vh - 56px)}
    .card{background:var(--panel);border:1px solid var(--outline);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25);padding:14px;min-height:0;overflow:auto}
    .card h2{margin:0 0 10px;font-size:13px;color:var(--muted);letter-spacing:.35px;font-weight:700;text-transform:uppercase}

    .leftTop{grid-column:1;grid-row:1}
    .leftBottom{grid-column:1;grid-row:2}
    .leftFooter{grid-column:1;grid-row:3}
    .visning{grid-column:2;grid-row:1 / span 2;display:grid;grid-template-rows:auto 1fr;gap:12px;min-height:0}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{background:var(--btn);border:0;color:white;padding:9px 12px;border-radius:11px;font-weight:700;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .btn-ghost{background:var(--btn-ghost);color:var(--ink);border:1px solid #2a3a5f}
    .btn-active{background:var(--btn-dark)} /* mörkare blå när INTE mute (aktiv monitor) */

    label{font-size:12px;color:var(--muted)}
    code.small{font-size:12px;color:var(--muted)}

    /* Visningens meters – kolumn 1 stor, kolumn 2 smal (för korrelation m.m.) */
    .meters{display:grid;grid-template-columns:minmax(340px,1fr) 220px;grid-auto-rows:auto;gap:12px;min-height:0;overflow:auto}
    .meter{background:#0b1222;border:1px solid #1a2745;border-radius:12px;padding:10px;position:relative;min-height:0}
    .meter header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #2a3a5f;background:#0b1222;color:#cfe1ff}
    .tiny{opacity:.85;font-size:12px}

    /* Canvas standardhöjder (utom goniometer som är exakt kvadrat) */
    canvas{display:block;width:100%;height:160px;background: radial-gradient(1200px 1200px at 50% 50%, #0b1020, #0b0f1a);border-radius:10px;border:1px solid #1a2745}

    /* Exakt kvadratisk goniometer */
    .xySquare{position:relative;width:100%}
    .xySquare>canvas{position:absolute;inset:0;width:100%;height:100%}
    .monoLine{position:absolute;left:50%;top:0;bottom:0;width:1px;background:#1f355f;pointer-events:none}

    /* VU staplar */
    .vu{position:relative;height:150px;background:#0a1020;border:1px solid #1a2745;border-radius:12px;overflow:hidden}
    .bar{position:absolute;bottom:0;width:42%;left:6%;background:linear-gradient(0deg,#1c7fff,#7ee787);height:0}
    .bar.r{left:auto;right:6%;background:linear-gradient(0deg,#c24bff,#ffb86b)}
    .ticks{position:absolute;inset:0;pointer-events:none}
    .tick{position:absolute;left:0;right:0;height:1px;background:#1b2a4a;opacity:.8}
    .tick::after{content:attr(data-db) " dB";position:absolute;right:6px;top:-7px;font-size:10px;color:#6a7aa6}

    .kv{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px}
    .kv div{background:#0b1222;border:1px solid #1a2745;border-radius:9px;padding:6px 8px}
    .kv small{display:block;font-size:11px;color:var(--muted)}
  </style>
</head>
<body>
<header><h1>TSG – Källor & Visning · Generator hörs (ON), System monitor OFF tills du säger till</h1></header>

<div id="wrap" class="wrap">
  <!-- Vänster kolumn: System/chrome överst, Generator underst (lika stora) -->
  <section class="card leftTop">
    <h2>System-/Chrome-flik</h2>
    <div class="row">
      <button id="btnTab">Starta capture</button>
      <button id="btnStop" class="btn-ghost" disabled>Stoppa capture</button>
    </div>
    <p class="tiny">Fångar via <code class="small">getDisplayMedia({audio:true})</code>. <b>Default:</b> capture AV, monitor OFF.</p>
    <div class="row" style="margin-top:6px;align-items:center">
      <label>System-monitor:</label>
      <input type="range" id="sysMonGain" min="0" max="1" step="0.01" value="0.20" />
      <span id="sysMonVal" class="tiny">0.20</span>
      <button id="btnSysMonMute" class="btn-ghost">Unmute system monitor</button>
      <span id="sysMonState" class="tiny">(tyst)</span>
    </div>
    <div class="kv" id="info">
      <div><small>Källa</small><span id="srcKind">–</span></div>
      <div><small>channelCount</small><span id="cc">–</span></div>
      <div><small>sampleRate</small><span id="sr">–</span></div>
      <div><small>stereo OK?</small><span id="stOK">–</span></div>
    </div>
    <p class="tiny">Tips: Undvik feedback. Dela <i>inte</i> denna tab om du tänker slå på system-monitor.</p>
  </section>

  <section class="card leftBottom">
    <h2>Intern testgenerator</h2>
    <div class="row" style="align-items:center">
      <button id="btnTone">Starta/Stoppa ton</button>
      <label><input type="checkbox" id="muteLeft"> Muta vänster 0,5 s var 1,5 s</label>
      <span class="badge">440 Hz · ~-18 dBFS</span>
    </div>
    <div class="row" style="margin-top:6px;align-items:center">
      <label>Generator-monitor:</label>
      <input type="range" id="monGain" min="0" max="1" step="0.01" value="0.20" />
      <span id="monVal" class="tiny">0.20</span>
      <button id="btnMonMute" class="btn-active">Mute generator monitor</button>
      <span id="monState" class="tiny">(på)</span>
    </div>
  </section>

  <!-- Ny huvudruta (halv höjd, lika bred som käll-rutorna) med uptime & live-data -->
  <section class="card leftFooter">
    <h2>Status & Live-data</h2>
    <div class="kv">
      <div><small>Uptime (s)</small><span id="uptime">0.0</span></div>
      <div><small>AudioContext</small><span id="ctxState">–</span></div>
      <div><small>Gen igång</small><span id="dbgGen">nej</span></div>
      <div><small>Tab igång</small><span id="dbgTab">nej</span></div>
    </div>
  </section>

  <!-- Höger kolumn: Visning (spänner två översta rader) -->
  <section class="card visning">
    <h2>Visning</h2>
    <div class="meters" id="meters">
      <!-- Rad 1: Goniometer vänster (stor, exakt kvadrat), Korrelation höger (liten ruta) -->
      <div class="meter">
        <header><label>Goniometer (XY)</label><span class="badge">RTW: mono = 45°</span></header>
        <div class="xySquare" id="xyWrap">
          <div class="monoLine"></div>
          <canvas id="xy"></canvas>
        </div>
      </div>
      <div class="meter" id="corrCard">
        <header><label>Correlation</label><span class="badge">−1 … +1</span></header>
        <canvas id="corr" height="220"></canvas>
        <p class="tiny">ρ = <span id="corrVal">0.00</span></p>
      </div>

      <!-- Rad 2: VU och Peak -->
      <div class="meter">
        <header><label>VU (0 ≈ −18 dBFS)</label><span class="badge">EBU-lik release</span></header>
        <div class="vu">
          <div class="bar l" id="barL"></div>
          <div class="bar r" id="barR"></div>
          <div class="ticks" id="ticks"></div>
        </div>
      </div>
      <div class="meter">
        <header><label>Peak hold</label><span class="badge">1 s hold</span></header>
        <canvas id="peak" height="160"></canvas>
      </div>
    </div>
  </section>
</div>

<script>
(async function(){
  // ------- DOM -------
  const wrap = document.getElementById('wrap');
  const meters = document.getElementById('meters');
  const xyWrap = document.getElementById('xyWrap');
  const btnTab  = document.getElementById('btnTab');
  const btnStop = document.getElementById('btnStop');
  const btnTone = document.getElementById('btnTone');
  const btnMonMute = document.getElementById('btnMonMute');
  const monState = document.getElementById('monState');
  const muteLeft = document.getElementById('muteLeft');
  const monGainEl = document.getElementById('monGain');
  const monVal = document.getElementById('monVal');

  const btnSysMonMute = document.getElementById('btnSysMonMute');
  const sysMonState = document.getElementById('sysMonState');
  const sysMonGainEl = document.getElementById('sysMonGain');
  const sysMonVal = document.getElementById('sysMonVal');

  const info = {
    srcKind: document.getElementById('srcKind'),
    cc: document.getElementById('cc'),
    sr: document.getElementById('sr'),
    stOK: document.getElementById('stOK')
  };

  const xy = document.getElementById('xy'),    xyCtx   = xy.getContext('2d');
  const corr = document.getElementById('corr'), corrCtx = corr.getContext('2d');
  const peak = document.getElementById('peak'), peakCtx = peak.getContext('2d');
  const barL = document.getElementById('barL'), barR = document.getElementById('barR');
  const ticks = document.getElementById('ticks');
  const corrVal = document.getElementById('corrVal');

  const ctxState = document.getElementById('ctxState');
  const dbgGen   = document.getElementById('dbgGen');
  const dbgTab   = document.getElementById('dbgTab');
  const uptimeEl = document.getElementById('uptime');

  // ------- Layout helpers -------
  function sizeWrap(){
    const headerH = document.querySelector('header').offsetHeight;
    wrap.style.height = `calc(100vh - ${headerH}px)`;
  }
  sizeWrap(); window.addEventListener('resize', sizeWrap);

  // Dynamisk goniometer: exakt kvadrat, fyll kolumnens bredd
  function layoutXY(){
    const dpr = window.devicePixelRatio || 1;
    const side = Math.max(240, xyWrap.clientWidth);
    xyWrap.style.height = side + 'px';
    xy.width  = Math.floor(side * dpr);
    xy.height = Math.floor(side * dpr);
  }

  // ------- Audio graph (central analys-mix) -------
  const ac = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
  ctxState && (ctxState.textContent = ac.state);
  ac.onstatechange = () => { if(ctxState) ctxState.textContent = ac.state };

  // mix-buss per kanal för analys
  const mixL = ac.createGain(); mixL.gain.value = 1;
  const mixR = ac.createGain(); mixR.gain.value = 1;
  const analyserL = ac.createAnalyser(); analyserL.fftSize = 2048;
  const analyserR = ac.createAnalyser(); analyserR.fftSize = 2048;
  mixL.connect(analyserL); mixR.connect(analyserR);
  const bufL = new Float32Array(analyserL.fftSize);
  const bufR = new Float32Array(analyserR.fftSize);

  function connectStereoToMix(node){
    const split = ac.createChannelSplitter(2);
    node.connect(split);
    split.connect(mixL,0);
    split.connect(mixR,1);
    return split;
  }

  // ------- VU helpers -------
  function buildTicks(){
    ticks.innerHTML='';
    const marks = [-24,-18,-12,-6,0];
    for(const db of marks){
      const y = (1 - (db+48)/48) * 100;
      const d = document.createElement('div');
      d.className='tick'; d.dataset.db = db; d.style.top = `calc(${y}% - 1px)`; ticks.appendChild(d);
    }
  }
  buildTicks();

  function dbfs(buf){
    let s=0; for(let i=0;i<buf.length;i++){ const v=buf[i]; s+=v*v }
    const rms = Math.sqrt(s/Math.max(1,buf.length));
    let db = 20*Math.log10(rms + 1e-12);
    if(!isFinite(db)) db = -120;
    return Math.max(-48, Math.min(0, db + 18));
  }

  // ------- Ritningar -------
  function drawVU(){
    analyserL.getFloatTimeDomainData(bufL); analyserR.getFloatTimeDomainData(bufR);
    const dl = dbfs(bufL), dr = dbfs(bufR);
    const atk=.5, rel=.012;
    holdL = dl>holdL ? holdL + atk*(dl-holdL) : holdL + rel*(dl-holdL);
    holdR = dr>holdR ? holdR + atk*(dr-holdR) : holdR + rel*(dr-holdR);
    barL.style.height = `${Math.max(0, Math.min(100,(holdL+48)/48*100))}%`;
    barR.style.height = `${Math.max(0, Math.min(100,(holdR+48)/48*100))}%`;
  }
  let holdL=-48, holdR=-48;

  function drawXY(){
    const w=xy.width,h=xy.height; if(!w||!h) return;
    xyCtx.clearRect(0,0,w,h);
    // Axes + 45° guides (RTW-känsla)
    xyCtx.strokeStyle = '#1c2b4c'; xyCtx.lineWidth = 1;
    xyCtx.beginPath();
    xyCtx.moveTo(w/2,0); xyCtx.lineTo(w/2,h); // vertikal
    xyCtx.moveTo(0,h/2); xyCtx.lineTo(w,h/2); // horisontell
    xyCtx.moveTo(0,h);   xyCtx.lineTo(w,0);   // 45°
    xyCtx.moveTo(0,0);   xyCtx.lineTo(w,h);   // -45°
    xyCtx.stroke();

    analyserL.getFloatTimeDomainData(bufL); analyserR.getFloatTimeDomainData(bufR);
    const n=Math.min(bufL.length,bufR.length);
    xyCtx.globalCompositeOperation='lighter';
    const dpr = window.devicePixelRatio||1; const px = Math.max(1, Math.floor(1.5*dpr));
    xyCtx.fillStyle='rgba(122,199,255,.95)';
    for(let i=0;i<n;i+=1){ const x=(bufL[i]*.5+.5)*w, y=(1-(bufR[i]*.5+.5))*h; xyCtx.fillRect(x,y,px,px) }
    xyCtx.globalCompositeOperation='source-over';
  }

  function corrNow(l,r){
    let n=Math.min(l.length,r.length), sL=0,sR=0; for(let i=0;i<n;i++){ sL+=l[i]; sR+=r[i] }
    const mL=sL/n, mR=sR/n; let num=0,dL=0,dR=0; for(let i=0;i<n;i++){ const L=l[i]-mL, R=r[i]-mR; num+=L*R; dL+=L*L; dR+=R*R }
    return num/(Math.sqrt(dL*dR)+1e-20);
  }
  let corrHold=0, corrUp=.35, corrDn=.08;
  function drawCorr(){
    analyserL.getFloatTimeDomainData(bufL); analyserR.getFloatTimeDomainData(bufR);
    const c = Math.max(-1, Math.min(1, corrNow(bufL,bufR)));
    corrHold = c>corrHold ? corrHold + corrUp*(c-corrHold) : corrHold + corrDn*(c-corrHold);

    const dpr = window.devicePixelRatio||1;
    const w = Math.floor(corr.clientWidth * dpr);
    const h = Math.floor(220 * dpr);
    if(corr.width!==w||corr.height!==h){ corr.width=w; corr.height=h }
    corrCtx.clearRect(0,0,w,h);

    // Skala: -1 (botten) → +1 (toppen)
    const yFromV = v => Math.round((1 - (v+1)/2) * (h-1));

    // Bakgrundsram
    corrCtx.strokeStyle='#1c2b4c';
    corrCtx.strokeRect(Math.floor(w*0.35), 4, Math.floor(w*0.30), h-8);

    // Tickmarks
    corrCtx.fillStyle='#6a7aa6';
    const ticksV = [-1,-0.5,0,+0.5,+1];
    for(const tv of ticksV){
      const y = yFromV(tv);
      corrCtx.fillRect(Math.floor(w*0.35)-6, y, 6, 1);
      corrCtx.fillRect(Math.floor(w*0.65), y, 6, 1);
      // små etiketter till höger
      corrCtx.font = `${Math.max(10,12*dpr)}px ui-sans-serif`;
      corrCtx.textBaseline='middle'; corrCtx.textAlign='left';
      corrCtx.fillText(tv.toString(), Math.floor(w*0.65)+8, y);
    }

    // Färg per zon
    const col = (corrHold<-0.2)?'#ff6b6b':(corrHold>0.9?'#7ee787':'#ffb86b');

    // Fylld stapel upp/från mitten? RTW brukar visa indikator; här gör vi en stapel med markör
    const y = yFromV(corrHold);
    corrCtx.fillStyle=col;
    corrCtx.fillRect(Math.floor(w*0.35)+2, y, Math.floor(w*0.30)-4, 4);

    // Center-linje (0)
    const y0 = yFromV(0);
    corrCtx.fillStyle='#2a3a5f';
    corrCtx.fillRect(Math.floor(w*0.35)+1, y0, Math.floor(w*0.30)-2, 1);

    corrVal.textContent = corrHold.toFixed(2);
  }

  let peakL=-120, peakR=-120, holdTimerL=0, holdTimerR=0;
  function drawPeak(){
    analyserL.getFloatTimeDomainData(bufL); analyserR.getFloatTimeDomainData(bufR);
    let pL=-120,pR=-120; for(let i=0;i<bufL.length;i++){ pL=Math.max(pL,20*Math.log10(Math.abs(bufL[i])+1e-9)); pR=Math.max(pR,20*Math.log10(Math.abs(bufR[i])+1e-9)); }
    const now=performance.now(); if(pL>=peakL-0.1){ peakL=pL; holdTimerL=now } if(pR>=peakR-0.1){ peakR=pR; holdTimerR=now }
    if(now-holdTimerL>1000) peakL-=0.5; if(now-holdTimerR>1000) peakR-=0.5;
    const dpr=window.devicePixelRatio||1; const w=Math.floor(peak.clientWidth*dpr), h=Math.floor(160*dpr);
    if(peak.width!==w||peak.height!==h){ peak.width=w; peak.height=h }
    peakCtx.clearRect(0,0,w,h);
    peakCtx.strokeStyle='#1c2b4c'; peakCtx.lineWidth=1; peakCtx.beginPath(); peakCtx.moveTo(0,h/2); peakCtx.lineTo(w,h/2); peakCtx.stroke();
    function xFromDb(db){ const c=Math.max(-60,Math.min(0,db)); return (c+60)/60*w }
    peakCtx.fillStyle='#7ee787'; peakCtx.fillRect(0,h*0.35,xFromDb(peakL),h*0.12);
    peakCtx.fillStyle='#ffb86b'; peakCtx.fillRect(0,h*0.55,xFromDb(peakR),h*0.12);
  }

  // ------- Loop & uptime -------
  let raf=0, startTs=performance.now();
  let leftMuted=false, leftMuteTimer=0;
  function loop(){
    // vänster mute-cykel för generatorn
    if (muteLeft.checked && leftGain){
      leftMuteTimer += 16.7; const period=1500, win=500; const on = (leftMuteTimer % period) >= win;
      const target = on ? 1 : 0; if (leftGain.gain.value !== target){ leftGain.gain.setValueAtTime(target, ac.currentTime) }
    }
    layoutXY();
    drawVU(); drawXY(); drawCorr(); drawPeak();
    uptimeEl.textContent = ((performance.now()-startTs)/1000).toFixed(1);
    raf = requestAnimationFrame(loop);
  }
  raf = requestAnimationFrame(loop);
  new ResizeObserver(()=>layoutXY()).observe(meters);

  // ------- Capture (system/chrome) – analys alltid, monitor via toggle -------
  let sysStream=null, sysSrc=null, sysSplit=null, sysMonGain=null, sysMonitorMuted=true;
  async function startTabCapture(){
    try{
      await ac.resume();
      sysStream = await navigator.mediaDevices.getDisplayMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false,channelCount:2}, video:true});
      sysStream.getVideoTracks().forEach(t=>t.stop());
      const track = sysStream.getAudioTracks()[0]; if(!track) throw new Error('Ingen ljudström exponerades.');
      try{ track.applyConstraints({advanced:[{channelCount:2}]}); }catch{}
      track.contentHint='music';
      sysSrc = ac.createMediaStreamSource(sysStream);
      sysSplit = connectStereoToMix(sysSrc); // analys
      // monitor OFF default
      sysMonGain = ac.createGain(); sysMonGain.gain.value = 0; sysSrc.connect(sysMonGain).connect(ac.destination);
      btnSysMonMute.classList.remove('btn-active'); btnSysMonMute.classList.add('btn-ghost');
      btnSysMonMute.textContent = 'Unmute system monitor'; sysMonState.textContent='(tyst)'; sysMonitorMuted=true;
      const set = track.getSettings?track.getSettings():{}; info.srcKind.textContent=track.kind||'audio'; info.cc.textContent=set.channelCount??'okänd'; info.sr.textContent=ac.sampleRate+' Hz'; info.stOK.textContent=(set.channelCount>=2?'Ja':'Osäkert/Mono?');
      btnTab.disabled=true; btnStop.disabled=false; dbgTab.textContent='ja';
    }catch(e){ alert(e.message||e) }
  }
  function stopCapture(){
    try{ sysStream && sysStream.getTracks().forEach(t=>t.stop()) }catch{}
    try{ sysSrc && sysSrc.disconnect() }catch{}
    try{ sysSplit && sysSplit.disconnect() }catch{}
    try{ sysMonGain && sysMonGain.disconnect() }catch{}
    sysStream=null; sysSrc=null; sysSplit=null; sysMonGain=null; sysMonitorMuted=true;
    btnSysMonMute.textContent='Unmute system monitor'; sysMonState.textContent='(tyst)'; btnSysMonMute.classList.remove('btn-active'); btnSysMonMute.classList.add('btn-ghost');
    btnTab.disabled=false; btnStop.disabled=true; dbgTab.textContent='nej';
  }
  function toggleSysMonitorMute(){
    if(!sysMonGain) return; // kräver aktiv capture
    sysMonitorMuted = !sysMonitorMuted;
    sysMonGain.gain.value = sysMonitorMuted ? 0 : parseFloat(sysMonGainEl.value);
    sysMonVal.textContent = sysMonGainEl.value;
    if (sysMonitorMuted){ btnSysMonMute.classList.remove('btn-active'); btnSysMonMute.classList.add('btn-ghost'); btnSysMonMute.textContent='Unmute system monitor'; sysMonState.textContent='(tyst)'; }
    else { btnSysMonMute.classList.add('btn-active'); btnSysMonMute.classList.remove('btn-ghost'); btnSysMonMute.textContent='Mute system monitor'; sysMonState.textContent='(på)'; }
  }
  sysMonGainEl.addEventListener('input', ()=>{ sysMonVal.textContent=sysMonGainEl.value; if(sysMonGain && !sysMonitorMuted){ sysMonGain.gain.value=parseFloat(sysMonGainEl.value) } });

  // ------- Generator (hörs + analys) – robust L/R utan Worklet -------
  let genOsc=null, genGain=null, leftGain=null, rightGain=null, merger=null, genMonGain=null, genSplit=null;
  let monitorMuted=false;
  async function startGenerator(){
    await ac.resume(); if(genOsc) return;
    genOsc = ac.createOscillator(); genOsc.type='sine'; genOsc.frequency.value=440;
    genGain = ac.createGain(); genGain.gain.value=0.18; // nivå in i analys/monitor
    leftGain = ac.createGain(); rightGain = ac.createGain(); leftGain.gain.value=1; rightGain.gain.value=1;
    merger = ac.createChannelMerger(2);
    genOsc.connect(genGain);
    genGain.connect(leftGain); genGain.connect(rightGain);
    leftGain.connect(merger,0,0); rightGain.connect(merger,0,1);
    // Monitor (default ON) + analys
    genMonGain = ac.createGain(); genMonGain.gain.value = parseFloat(monGainEl.value);
    merger.connect(genMonGain).connect(ac.destination);
    genSplit = connectStereoToMix(merger);
    genOsc.start();
    btnTone.textContent='Stoppa ton'; dbgGen.textContent='ja';
    monitorMuted=false; btnMonMute.classList.add('btn-active'); btnMonMute.classList.remove('btn-ghost'); monState.textContent='(på)';
  }
  async function stopGenerator(){
    try{ genOsc && genOsc.stop() }catch{}
    [genOsc,genGain,leftGain,rightGain,merger,genMonGain,genSplit].forEach(n=>{ try{ n && n.disconnect && n.disconnect() }catch{} });
    genOsc=null; genGain=null; leftGain=null; rightGain=null; merger=null; genMonGain=null; genSplit=null;
    btnTone.textContent='Starta ton'; dbgGen.textContent='nej';
  }
  async function toggleTone(){ if(!genOsc) await startGenerator(); else await stopGenerator() }

  function toggleGenMonitorMute(){
    if(!genMonGain) return;
    monitorMuted = !monitorMuted;
    genMonGain.gain.value = monitorMuted ? 0 : parseFloat(monGainEl.value);
    monVal.textContent = monGainEl.value;
    if (monitorMuted){ btnMonMute.classList.remove('btn-active'); btnMonMute.classList.add('btn-ghost'); btnMonMute.textContent='Unmute generator monitor'; monState.textContent='(tyst)'; }
    else { btnMonMute.classList.add('btn-active'); btnMonMute.classList.remove('btn-ghost'); btnMonMute.textContent='Mute generator monitor'; monState.textContent='(på)'; }
  }
  monGainEl.addEventListener('input', ()=>{ monVal.textContent=monGainEl.value; if(genMonGain && !monitorMuted){ genMonGain.gain.value=parseFloat(monGainEl.value) } });

  // ------- Bind -------
  btnTab.onclick  = startTabCapture;
  btnStop.onclick = stopCapture;
  btnTone.onclick = toggleTone;
  btnMonMute.onclick = toggleGenMonitorMute;
  btnSysMonMute.onclick = toggleSysMonitorMute;

  // ------- Defaults (autoplay-safe: starta generatorn ON efter första gest) -------
  let booted=false; async function boot(){ if(booted) return; booted=true; await ac.resume(); await startGenerator(); }
  ['pointerdown','click','keydown','touchstart'].forEach(evt=>window.addEventListener(evt, boot, { once:true, passive:true }));
})();
</script>
</body>
</html>
